name: Docs

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Clonar el repo
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # 2️⃣ Configurar Python
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      # 3️⃣ Instalar dependencias
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .[docs]

      # 4️⃣ Generar documentación
      - name: Generate docs Aplicacion
        run: python -m pdoc -o docs/aplicacion aplicacion

      - name: Generate docs Persistencia
        run: python -m pdoc -o docs/persistencia persistencia

      # 5️⃣ Publicar en gh-pages
      - name: Deploy to gh-pages
        env:
          GH_PAGES_TOKEN: ${{ secrets.GH_PAGES_TOKEN }}
        run: |
          # Configura git con el token
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          # Carpeta temporal para publicar
          TARGET_DIR=$(mktemp -d)

          # Clonar o crear gh-pages
          if git ls-remote --exit-code origin gh-pages; then
            git clone --branch gh-pages https://x-access-token:${GH_PAGES_TOKEN}@github.com/${GITHUB_REPOSITORY}.git $TARGET_DIR
          else
            git clone https://x-access-token:${GH_PAGES_TOKEN}@github.com/${GITHUB_REPOSITORY}.git $TARGET_DIR
            cd $TARGET_DIR
            git checkout --orphan gh-pages
            cd -
          fi

          # Copiar docs
          rsync -av --delete docs/ $TARGET_DIR/

          # Commit y push
          cd $TARGET_DIR
          git add --all
          git commit -m "Deploy documentation $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push origin gh-pages --force
